/* CursorJs 2014-11-10 */
!function(a,b){if("funciton"==typeof define&&define.amd)define(["Zepto","exports"],function(c,d){a.Cursor=b(c,d)});else if("undefined"!=typeof exports){var c=require("jQuery");b(c,exports)}else{var d=function(){};a.Cursor=b(window.Zepto||window.jQuery,d)}}(this,function(a,b){function b(c){return this instanceof b?(a.extend(this,b.defaults,c),this.$table=a("."+this.table),this.$cursor=null,this.matrix=[],this.n0=this.init[0],this.n1=this.init[1],this.n2=this.init[2],this.data=[],this.$now=null,this.$focusing=null,void this._init()):new b(c)}return Function.prototype.before=function(a){var b=this;return function(){return a.apply(this,arguments)===!1?!1:b.apply(this,arguments)}},Function.prototype.after=function(a){var b=this;return function(){return b.apply(this,arguments)===!1?!1:a.apply(this,arguments)}},b.defaults={wrap:"body",table:"j-table",tr:"j-tr",td:"j-td",init:[0,0,0],keydownFn:function(){}},b.prototype._init=function(){this.push(this.$table),this._renderCursor(),this._bind()},b.prototype._renderCursor=function(){var b=this,c='<div class="g-focus"><table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="bgLt" width="40" height="40"></td><td class="bgT"></td><td class="bgRt" width="40" height="40"></td></tr><tr><td class="bgL"></td><td></td><td class="bgR"></td></tr><tr><td class="bgLb" width="40" height="40"></td><td class="bgB"></td><td class="bgRb" width="40" height="40"></td></tr></tbody></table></div>';this.$cursor=a(c).appendTo(a(this.wrap)).hide(),setTimeout(function(){b.focus();var a=b.getFocusing();b.keydownFn(a),"focus"!==a.data("type")&&b.$cursor.show()},100)},b.prototype.focus=function(){arguments[0]&&(this.$focusing=this.matrix[this.n0][this.n1][this.n2],this.getFocusing().removeClass("s-cursoring"),this.n0=arguments[0][0],this.n1=arguments[0][1],this.n2=arguments[0][2]),this.$focusing=this.matrix[this.n0][this.n1][this.n2];var a=this.getFocusing();return a.addClass("s-cursoring"),"focus"===a.data("type")?(a.focus(),void this.$cursor.hide()):void("body"===this.wrap?(a.focus(),this.$cursor.css({width:parseInt(a.css("width"))+70+"px",height:parseInt(a.css("height"))+70+"px",left:parseInt(a.offset().left)-35+"px",top:parseInt(a.offset().top)-35+"px"}).show()):(document.activeElement.blur(),this.$cursor.css({left:parseInt(a.position().left)-35+"px",top:parseInt(a.position().top)-35+"px",width:parseInt(a.css("width"))+70+"px",height:parseInt(a.css("height"))+70+"px"}).show()))},b.prototype.push=function(b){var c,d=this,e=d.tr,f=d.td,g=d.matrix;b.each(function(){c=a(this).data("nth"),g[c]=[],a(this).find("."+e).each(function(b){g[c][b]=[],a(this).find("."+f).each(function(d){var e=parseInt(a(this).attr("colspan"));if(a(this).attr({"data-matrix":c+"-"+b+"-"+d}),a(this).attr({"data-matrix":c+"-"+b+"-"+d}),""+e!="NaN"){var f=e,h=2,i=f-1;for(g[c][b].push([a(this),{start:f}]),--e;e;)g[c][b].push(1===e?[a(this),{end:f}]:[a(this),{left:h++,right:i--}]),--e}else g[c][b].push(a(this))})})}),this.$table=a("."+this.table)},b.prototype._setMatrix=function(a,b){var c=this.getFocusing(),d=this.$table.filter('[data-nth="'+this.n0+'"]').data("remember"),e=c.data("matrix");if(this.n0=parseInt(a[0],10),this.n1=parseInt(a[1],10),this.n2=parseInt(a[2],10),c=this.matrix[this.n0][this.n1][this.n2],"no"!==d){c=2===c.length?c[0]:c;var f="right"===b?3:"left"===b?1:"up"===b?2:"down"===b?0:"",g=this.$table.filter('[data-nth="'+this.n0+'"]');try{var a=g.data("focus").split(",")}catch(h){throw new Error("需要先将所有的j-table都加上data-focus属性")}a[f]=e,g.data("focus",a.toString())}},b.prototype._getData=function(){var a=this.$table.filter('[data-nth="'+this.n0+'"]').data("focus");return this.data=void 0===a?["","","",""]:a.split(",")},b.prototype.getFocusing=function(){var a=this.$focusing;return a=2===a.length?a[0]:a},b.prototype._removePrevClass=function(){this.getFocusing().removeClass("s-cursoring")},b.prototype._getright=function(){var a=this.matrix[this.n0],b=this.matrix[this.n0][this.n1],c=(a.length,b.length),d=b[this.n2];if(this.n2<c-1)if(2===d.length){var e=this.n2;if(d[1].start?this.n2+=d[1].start:d[1].right?this.n2+=d[1].right:d[1].end&&++this.n2,this.n2>=c-1){this._getData();var f=this.data[1];if(""===f)return void(this.n2=e);f=f.split("-"),this._setMatrix(f,"right")}}else++this.n2;else{this._getData();var f=this.data[1];f&&(f=f.split("-"),this._setMatrix(f,"right"))}},b.prototype._getleft=function(){var a=this.matrix[this.n0],b=a[this.n1],c=(a.length,b[this.n2]);if(this.n2>0)if(2===c.length){var d=this.n2;if(c[1].end?this.n2-=c[1].end:c[1].left?this.n2-=c[1].left:c[1].start&&--this.n2,this.n2<0){this._getData();var e=this.data[3];if(""===e)return void(this.n2=d);e=e.split("-"),this._setMatrix(e,"left")}}else--this.n2;else{this._getData();var e=this.data[3];e&&(e=e.split("-"),this._setMatrix(e,"left"))}},b.prototype._getup=function(){{var a=this.matrix[this.n0];a.length}if(this.n1>0)--this.n1;else{this._getData();var b=this.data[0];b&&(b=b.split("-"),this._setMatrix(b,"up"))}},b.prototype._getdown=function(){var a=this.matrix[this.n0],b=a.length;if(this.n1<b-1)++this.n1;else{this._getData();var c=this.data[2];c&&(c=c.split("-"),this._setMatrix(c,"down"))}},b.prototype.goright=function(){this._removePrevClass(),this._getright(),this.focus()},b.prototype.goleft=function(){this._removePrevClass(),this._getleft(),this.focus()},b.prototype.goup=function(){this._removePrevClass(),this._getup(),this.focus()},b.prototype.godown=function(){this._removePrevClass(),this._getdown(),this.focus()},b.prototype.ok=function(){},b.prototype._bind=function(){var b=this;a(document).keydown(function(a){var c=a.keyCode;switch(c){case 37:b.goleft(b.getFocusing()),a.preventDefault();break;case 38:b.goup(b.getFocusing()),a.preventDefault();break;case 39:b.goright(b.getFocusing()),a.preventDefault();break;case 40:b.godown(b.getFocusing()),a.preventDefault();break;case 13:b.ok(b.getFocusing())}b.keydownFn(b.getFocusing())})},b});